<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rocket Run Pro - FIX FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.js"></script>
    <style>
        body, html { margin:0; padding:0; overflow:hidden; background:#000; touch-action:none; user-select:none; }
        canvas { display:block; margin:auto; border:3px solid #0f0; border-radius:12px; }
        #debug {
            position:fixed; top:10px; left:10px; background:rgba(0,0,0,0.8); color:#0f0;
            font:0.9rem monospace; padding:10px; border-radius:8px; z-index:999; border:1px solid #0f0;
        }
        #start {
            position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(10,0,20,0.98);
            display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; z-index:1000;
        }
        .btn { margin:10px; padding:18px 40px; font-size:1.3rem; font-weight:bold; border:none; border-radius:12px; cursor:pointer; }
        .easy { background:#00A389; color:white; }
        .medium { background:#ffc107; color:#333; }
        .insane { background:#F44336; color:white; }
    </style>
</head>
<body>

<div id="start">
    <h1>ROCKET RUN PRO</h1>
    <div class="btn easy" onclick="start('easy')">FÁCIL</div>
    <div class="btn medium" onclick="start('medium')">MÉDIO</div>
    <div class="btn insane" onclick="start('insane')">LOCO</div>
    <p style="margin-top:30px; color:#ffcc00;">TOQUE NA TELA PARA SUBIR</p>
</div>

<div id="debug">Carregando...</div>

<script>
    let canvas, rocket = {x:0, y:0, vx:0, vy:0}, fuel = 100, score = 0, high = 0;
    let asteroids = [], stars = [], state = 'menu', diff = 'easy';
    let isThrust = false, debugCount = 0;

    const CFG = {
        easy:   {g:0.1, gap:200, thrust:-0.7, max:4, base:2, drag:0.98},
        medium: {g:0.4, gap:140, thrust:-1.0, max:6, base:4, drag:0.97},
        insane: {g:0.8, gap:100, thrust:-1.3, max:8, base:7, drag:0.96}
    };

    function start(d) {
        diff = d;
        const c = CFG[d];
        Object.assign(window, {g:c.g, gap:c.gap, thrust:c.thrust, max:c.max, speed:c.base, drag:c.drag});

        let w = min(800, windowWidth-20), h = min(450, windowHeight-100);
        canvas = createCanvas(w, h);
        canvas.parent(document.body);
        document.getElementById('start').remove();

        rocket = {x: w/4, y: h/2, vx:0, vy:0};
        fuel = 100; score = 0; asteroids = [new Asteroid()];
        for(let i=0;i<150;i++) stars.push({x:random(w),y:random(h),s:random(1,3),v:random(0.5,2)});

        state = 'play';
        loop();
        updateDebug('JOGO INICIADO');
    }

    function setup() {
        noLoop();
        updateDebug('setup OK');
    }

    function draw() {
        if (state !== 'play') return;

        clear();
        background(10, 0, 20);

        // === TOQUE ATIVO? ===
        isThrust = mouseIsPressed || (touches && touches.length > 0);

        // === FÍSICA ===
        if (isThrust) rocket.vy += thrust * 2.8;
        rocket.vy += g;
        rocket.vx *= drag; rocket.vy *= drag;
        rocket.vx = constrain(rocket.vx, -max, max);
        rocket.vy = constrain(rocket.vy, -max, max);
        rocket.x += rocket.vx; rocket.y += rocket.vy;
        rocket.x = constrain(rocket.x, 20, width-20);
        rocket.y = constrain(rocket.y, 20, height-20);

        fuel -= 0.05 * (isThrust ? 2 : 1);
        if (fuel <= 0) gameOver("SEM COMBUSTÍVEL");

        // === DESENHO ===
        drawStars();
        drawRocket();
        updateAsteroids();
        drawHUD();

        updateDebug(`Thrust: ${isThrust} | Vy: ${rocket.vy.toFixed(2)} | Y: ${floor(rocket.y)}`);
    }

    function drawRocket() {
        push();
        translate(rocket.x, rocket.y);
        rotate(map(rocket.vy, -max, max, -0.3, 0.3));
        if (isThrust) { fill(255,150,0,220); ellipse(-20,0,16,26); }
        fill(180); triangle(-15,-15,-15,15,15,0);
        fill(200,50,50); triangle(15,0,10,-5,10,5);
        pop();
    }

    function drawStars() {
        fill(255);
        for(let s of stars) {
            s.x -= s.v * speed * 0.5;
            if(s.x < 0) s.x = width;
            ellipse(s.x, s.y, s.s);
        }
    }

    function updateAsteroids() {
        for(let i=asteroids.length-1; i>=0; i--) {
            let a = asteroids[i];
            a.x -= speed;
            fill(100,50,50); stroke(200,50,50); strokeWeight(2);
            rect(a.x, 0, 50, a.top);
            rect(a.x, a.bottom, 50, height-a.bottom);
            if (dist(rocket.x, rocket.y, a.x+25, a.center) < 40 && (rocket.y < a.top || rocket.y > a.bottom)) {
                gameOver("COLISÃO!");
            }
            if (a.x < -60) {
                score++; fuel = 100;
                asteroids.splice(i,1);
                asteroids.push(new Asteroid());
            }
        }
    }

    function drawHUD() {
        fill(255); textSize(20); textAlign(LEFT);
        text(`SCORE: ${score}`, 20, 30);
        text(`REC: ${high}`, 20, 60);
        fill(0,200,0); rect(20, 80, map(fuel,0,100,0,200), 15);
    }

    function gameOver(msg) {
        state = 'over';
        if (score > high) { high = score; localStorage.setItem('rrhs', high); }
        noLoop();
        setTimeout(() => alert(`${msg}\nPontuação: ${score}\nRecorde: ${high}`), 100);
        setTimeout(() => location.reload(), 2000);
    }

    class Asteroid {
        constructor() {
            this.center = random(100, height-100);
            this.gap = gap/2;
            this.top = this.center - this.gap;
            this.bottom = this.center + this.gap;
            this.x = width;
        }
    }

    function updateDebug(msg) {
        debugCount++;
        document.getElementById('debug').innerHTML = `
            Eventos: ${debugCount}<br>
            Estado: ${state}<br>
            ${msg}
        `;
    }

    // === EVENTOS GLOBAIS ===
    function touchStarted() { if(state==='play') isThrust=true; return false; }
    function touchEnded() { if(state==='play') isThrust=false; return false; }
    function mousePressed() { return touchStarted(); }
    function mouseReleased() { return touchEnded(); }

    document.addEventListener('touchstart', e=>e.preventDefault(), {passive:false});
    document.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});

    high = parseInt(localStorage.getItem('rrhs')||0);
</script>
</body>
</html>
